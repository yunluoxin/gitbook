# LLDB ä½¿ç”¨

`ASLR (Adress Space Layout Randomration)` : åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–

*ä»£ç çš„åœ°å€ï¼ˆå‡½æ•°çš„å†…å­˜åœ°å€ï¼‰ = ASLRåç§» + ä»£ç åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡*

### è·å– ASLR 

```lldb
# è·å–æ‰€æœ‰çš„åŠ¨æ€åº“çš„åç§»å’Œæ–‡ä»¶åœ°å€ç­‰
image list

image list -f -o
#todo: å’Œç›´æ¥çš„ image list å·®åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
```



## å¸®åŠ©

lldb çš„å‘½ä»¤éå¸¸å¤šï¼Œä¸å¯èƒ½éƒ½åˆ—ä¸¾ã€‚å½“å¿˜è®°å‘½ä»¤æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡ `apropos` å‘½ä»¤å¸®ä½ ï¼š

```lldb
apropos breakpoint		# å¯ä»¥æ˜¾ç¤ºå‡º breakpoint æ‰€æœ‰å¯ç”¨çš„å‘½ä»¤
apropos watchpoint 
```



## æ–­ç‚¹

### æŸ¥çœ‹æ–­ç‚¹

- `breakpoint list`

- `br list`

- `b`



### è®¾ç½®æ–­ç‚¹å¯ä»¥ç”¨

- `breakpoint set xxxx`
- `br s xxxx`
- `b xxxx` 



### é€šè¿‡ç¬¦å·æ–­ç‚¹ï¼ˆOCç”¨çš„ï¼ŒSwiftä¸çŸ¥é“ï¼‰
- `b -[SKPaymentQueue addPayment:]` 

  > è®°ä½ **:** å·ä¸èƒ½çœç•¥
  >
  > ğŸ˜ æ–­ç‚¹è¿™ä¸ªåï¼Œå¯ä»¥é€šè¿‡ `po [((SKPayment *)$x2) productIdentifier]` å¾—åˆ°å½“å‰æ­£åœ¨ä»˜æ¬¾çš„SKU



### é€šè¿‡åœ°å€æ–­ç‚¹

```lldb
br s -a ä»£ç çš„åœ°å€
# æˆ–è€…
br s -a ASLRåç§»+æ–‡ä»¶åç§»é‡
# æˆ–è€…
br s --address ä»£ç çš„åœ°å€
# ã€‚ã€‚ã€‚ã€‚æ›´å¤šæ–¹å¼
```



### å¯ç”¨æ–­ç‚¹

```lldb
br enable 1
# å…¶ä¸­1æ˜¯br list æ˜¾ç¤ºä¸­å¯ä»¥çœ‹åˆ°çš„ï¼Œæ–­ç‚¹åºå·
```



### ç¦ç”¨æ–­ç‚¹

```lldb
br disable 1
```



### åˆ é™¤æ–­ç‚¹

```lldb
br delete 1		# åˆ é™¤æ–­ç‚¹1
br delete 		# åˆ é™¤æ‰€æœ‰
```



### â¸ æš‚åœï¼ˆä¸­æ–­ï¼‰ç¨‹åº

ç¨‹åºè¿è¡Œä¸­ï¼Œè‹¥æƒ³ç»§ç»­è®¾ç½®æ–­ç‚¹ç­‰ï¼Œå¯åœ¨ lldb å‘½ä»¤ä¸­ç›´æ¥ä½¿ç”¨ `Control + C`ï¼Œå³å¯ä¸­æ–­ç¨‹åºæ‰§è¡Œã€‚æˆ–è€…æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ï¼š

```lldb
process interrupt
```



## è°ƒè¯•

ç»§ç»­è¿è¡Œ

```lldb
c
# æˆ–è€…
continue
```

æ­¥è¿›

```lldb
s
# æˆ–è€…
step
```

ä¸‹ä¸€æ­¥

```lldb
n
# æˆ–è€…
next
```

è·³å‡ºå­ç¨‹åº

```lldb
finish
```

ç›´æ¥è¿”å›ï¼ˆé€‚ç”¨äºå¿½ç•¥åé¢çš„ä»£ç ï¼Œæå‰è¿”å›ã€‚åŠ¨æ€è°ƒè¯•æ—¶å€™ï¼Œå¯ä»¥ç»•è¿‡æ£€æµ‹å‡½æ•°ï¼‰

```lldb
thread return
```



## å¯„å­˜å™¨

LLDBä¸­æ“ä½œå¯„å­˜å™¨çš„å‘½ä»¤æ˜¯ `register`

### è¯»å–å¯„å­˜å™¨

```lldb
register read 			# è¾“å‡ºå½“å‰æ‰€æœ‰çš„å¯„å­˜å™¨ä¿¡æ¯
register read $x0		# è¯»å–x0å¯„å­˜å™¨
```

å°† x1 å¯„å­˜å™¨çš„ Cå­—ç¬¦ä¸² æ‰“å°å‡ºæ¥ï¼š

```lldb
x/s $x1
```

å¦‚æœå¯„å­˜å™¨é‡Œçš„å€¼æ˜¯å¯¹è±¡ï¼Œè¿˜å¯ä»¥ç”¨ `po (print object)` å‘½ä»¤

```lldb
po $x0
po [$x0 config]	# å‡è®¾ x0 å¯¹è±¡æœ‰ config å±æ€§
```

`p (print)` å‘½ä»¤ç›´æ¥è¾“å‡ºåŸç”Ÿç±»å‹çš„ä¿¡æ¯ï¼Œå¯ä»¥æŒ‡å®šè¾“å‡ºçš„æ ¼å¼

```lldb
p/x $x2 	# è¾“å‡º16è¿›åˆ¶çš„
p/d $x2 	# è¾“å‡ºæ•´æ•°
```



### å†™å¯„å­˜å™¨

```lldb
register write $x0 1	# å¯¹å¯„å­˜å™¨x0å†™å…¥å€¼1
```



## å†…å­˜æ“ä½œ

LLDBä¸­æ“ä½œå†…å­˜çš„å‘½ä»¤æ˜¯ `memory`ï¼Œä¸»è¦åˆ†ä¸ºè¯»å–ã€ä¿å­˜ä¸ä¿®æ”¹ã€‚

### è¯»å–å†…å­˜

ä½¿ç”¨ `read` å‚æ•°è¯»å–æŒ‡å®šå†…å­˜ï¼Œæ”¯æŒå¯„å­˜å™¨åœ°å€å’Œå†…å­˜åœ°å€è¯»å–ï¼Œ`-c` å‚æ•°æŒ‡å®šè¦è¯»å–çš„å­—èŠ‚

```lldb
memory read $x0									# è¯»å–å¯„å­˜å™¨
memory read -c 100 0xabcdef			# æŒ‰ä¸ªæ•°è¯»å–
memory read 0xabcdef 0xfedcba		# æŒ‰åŒºåŸŸè¯»å–
```

å¦‚æœè¢«è¯»å–çš„æ•°æ®è¶…è¿‡1024å­—èŠ‚ï¼Œå°±ä¼šå‡ºç°é”™è¯¯ï¼ŒåŠ å…¥--forceå‚æ•°å³å¯è§£å†³ï¼š

```lldb
memory read -c 1025 --force 0xabcdef
```



### å†™å…¥å†…å­˜

```lldb
memory write 0xabcdef 0x24	# å¯¹0xabcdefçš„å†…å­˜å†™å…¥å€¼
```

> #todo: çœ‹ä¹¦é‡Œå†™çš„ï¼Œè¿™é‡Œå¥½åƒåªä¼šå†™å…¥ä¸€ä¸ªå­—èŠ‚ï¼Ÿ



### ä¿å­˜æ–‡ä»¶

```lldb
memory read -c 300 0xabcdef --outfile /path/to/txt
```

å¦‚æœåªéœ€è¦ä¿å­˜åŸå§‹å­—èŠ‚ï¼ŒåŠ å…¥--binaryå‚æ•°å³å¯ï¼š

```lldb
memory read -c 300 0xabcdef --binary --outfile /path/to/txt
```

> #todo: ä»€ä¹ˆæ˜¯åŸå§‹å­—èŠ‚ï¼Ÿ



## å†…å­˜ç›‘è§†

`watchpoint` ç”¨æ¥ç›‘è§†æŸä¸ªå†…å­˜çš„å˜åŒ–ï¼Œå¯ä»¥ç†è§£ä¸º **å†…å­˜æ–­ç‚¹**ã€‚æ¯”å¦‚åœ¨è°ƒè¯•æ¸¸æˆæ•°æ®æ—¶ï¼Œæƒ³çŸ¥é“ç”Ÿå‘½å€¼ä»€ä¹ˆæ—¶å€™è¢«ä¿®æ”¹å°±å¯ä»¥ä½¿ç”¨å®ƒã€‚å®ƒåŒ…æ‹¬è®¿é—®ï¼ˆreadï¼‰ã€å†™å…¥ï¼ˆwriteï¼‰åŠè¯»å†™ï¼ˆread_writeï¼‰ä¸‰ç§ç±»å‹

### å†…å­˜è®¿é—®

```lldb
watchpoint set expression -w read -- 0xabcdef
```

### å†…å­˜å†™å…¥

```lldb
watchpoint set expression -w write -- 0xabcdef
```


### å†…å­˜è¯»å†™

```lldb
watchpoint set expression -w read_write -- 0xabcdef
```

### æ¡ä»¶ç›‘è§†

```lldb
watchpoint modify -c '*(char *)0xabcdef == 20'
```

### å…¶ä»–
åƒ list/delete/enable/disable çš„ï¼Œéƒ½å’Œ breakpoint ä¸€æ ·ï¼Œ eg: `watchpoint list`



## åæ±‡ç¼–
`disassemble`ï¼ˆå¯ä»¥ç®€å†™ä¸º â€œ`dis`â€ï¼‰å‘½ä»¤å¯ä»¥åæ±‡ç¼–æŒ‡å®šåœ°å€ï¼Œæ”¯æŒå¯„å­˜å™¨æ‰€å¯¹åº”çš„åœ°å€æˆ–ç›´æ¥åœ°å€ï¼š

```lldb
disassemble -a 0xabcdef
# æˆ–åˆ™
disassmeble -a $pc
```





## è°ƒç”¨æ ˆ

ä½¿ç”¨ bt å‘½ä»¤å¯ä»¥æ‰“å°å‡ºæ‰€æœ‰è°ƒç”¨æ ˆï¼Œåé¢åŠ å…¥ç¼–å·å¯ä»¥æŒ‡å®šæ‰“å°å‡ å±‚

```lldb
bt
bt 1	# æ‰“å°ç¬¬ä¸€å±‚
```



## é™„å½•

1. [å®˜æ–¹LLDBæ–‡æ¡£](https://developer.apple.com/library/archive/documentation/IDEs/Conceptual/gdb_to_lldb_transition_guide/document/lldb-terminal-workflow-tutorial.html)
